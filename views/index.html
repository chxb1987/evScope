{%extends 'templates/layout.html' %}
{% block content %}

<script type="text/javascript" src="http://canvg.github.io/canvg/rgbcolor.js"></script> 
<script type="text/javascript" src="http://canvg.github.io/canvg/StackBlur.js"></script>
<script type="text/javascript" src="http://canvg.github.io/canvg/canvg.js"></script> 
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<!-- end of goole gauge -->
<div class="container">
<div class="top">
	<div class='head title1'>
		<span id='stater' class='csStateLampReady'>대기중</span>
		<span class="title1 titleName">인버터 스코프</span>
	</div>
	<div id='bottomBox' class='csBottomBox'> 
	</div>
	<div id='timeStampBox' class = 'csTimeStampBox'>
		<span class='titleName1'>경과시간></span>
		<span id='endTimeStamp' class='titleName1'>00시간 00분 00초</span>
		<span class='titleName'>현재시간</span>
		<span id='clock1' class='titleName'>2018:02:07: 10:10:00</span>
		<br>	
		<span class='titleName1'> 시작시간</span>
		<span id='startTimeStamp' class='titleName1'>2018:02:07: 10:10:00</span>
		<span class='titleName'>정지시간</span>
		<span id='endTimeStamp' class='titleName'>2018:02:07: 10:10:00</span>
	</div>
	<div id="plotRpm">
		<div id="plot1-parent" class="csPlot1">
			<canvas id="plot1" class="oscope-canvas oscope-canvas2" width="600" height="200"></canvas>
		</div>
		<div id = "plotName">
			<button id='btnInvStart'	class='w3-button w3-round w3-green' onclick='btnInvStart()'>유압동작</button>
			<button id='btnTestOn'		class='w3-button w3-round w3-green' onclick='btnTestOn()'>실험시작</button -->
			<button id='btnArmOn'	class='w3-button w3-round w3-green   ' onclick='btnArmOn()'>전진</button>
			<button id='btnMonitorStart'	class='w3-button w3-round w3-blue   ' onclick='btnMonitorStart()'>StartGraph</button>
			</br>--------------------------------------
			</br>
			<button id='btnInvStop'		class='w3-button w3-round w3-red'	onclick='btnInvStop()'>유압정지</button>
			<button id='btnTestOff'	class='w3-button w3-round w3-red'		onclick='btnTestOff()'>실험정지</button>
			<button id='btnArmOff'	class='w3-button w3-round w3-red' onclick='btnArmOff()'>후진</button>
			<button id='btnMonitorStop'	class='w3-button w3-round w3-red' onclick='btnMonitorStop()'>Stop Graph</button>
			</br>
			<button id='btnShutDown' class='w3-button w3-round w3-indigo ' onclick='btnShutDown()'>SHUTDOWN</button>
			<button id='btnNoVac' 	class='w3-button w3-round w3-green  ' onclick='changeNoVac()'>동작버튼5</button>
			<!--button id='btnTraceOnOff'	class='w3-button w3-round w3-red' onclick='btnTraceOnOff()'>실험시작</button -->
			<!-- button id='btnReadAll' 	class='w3-button w3-round w3-green ' onclick='btnReadAll()'>ReadAll</button -->

		</did> <!-- end of plotName -->
	</div> <!-- end of plotRpm-->
</div> <!-- p-->

<div id='leftBox' class='csLeftBox'>

	<div id="oscope-parent" class="csOscope">
		<canvas id="oscope" class="oscope-canvas" width='600' height='400' ></canvas>
	</div>

</div> <!-- end of leftBox -->

	<div class="csRightBox">
		<div id = 'chanOptions'>
			<table>
				<tr>
					<th><font color= "gold">CH1</font></th> 
					<th class="csCh1List1">
						<select name="ch1_list1" onChange="updateCh1Select(this.selectedIndex)">
						<option selected>probe </option> 
						<option value='I'>Amp </option>
						<option value='V'>Volt </option>
						<option value='adc'>ADC </option>
						<option value='pwm'>PWM </option>
						</select>
						<select name="ch1_list1_list2" onClick="alert(this.options[this.options.selectedIndex].value)">
						</select>
					</th> 
					<th> 
						<select id="idCh1Div">
			            <option value="0">1.0A/div</option>
			            <option value="1">5.0A/div</option>
			            <option value="2">10.0A/div</option>
			            <option value="3">20.0A/div</option>
			            <option value="4">50.0V/div</option>
			            <option value="5">100.0/div</option>
         			</select>
					</th>
					<th><font color="gold">OFFSET</font>
						<input id='ch1Offset' type="number" class="offset" value="0" size="3">
					</th>
				</tr>

				<tr>
					<th><font color="blue">CH2</font></th> 
					<th>
						<select name="ch2_list1" onChange="updateCh2Select(this.selectedIndex)">
						<option selected>probe</option>
						<option value='I'>Amp</option>
						<option value='V'>Volt</option>
						<option value='adc'>ADC</option>
						<option value='pwm'>PWM</option>
						</select>
						<select name="ch2_list1_list2" onClick="alert(this.options[this.options.selectedIndex].value)">
						</select>
					</th> 
					<th> 
						<select id="idCh2Div">
			            <option value="0">1.0A/div</option>
			            <option value="1">5.0A/div</option>
			            <option value="2">10.0A/div</option>
			            <option value="3">20.0A/div</option>
			            <option value="4">50.0V/div</option>
			            <option value="5">100.0/div</option>
         			</select>
					</th>
					<th><font color="blue">OFFSET</font> 
						<input id='ch2Offset' type="number" class="offset" value="0" size="3">
					</th>
				</tr>

				<tr>
					<th><font color="hotpink">CH3</font></th> 
					<th>
						<select name="ch3_list1" onChange="updateCh3Select(this.selectedIndex)">
						<option selected>probe</option>
						<option value='I'>Amp</option>
						<option value='V'>Volt</option>
						<option value='adc'>ADC</option>
						<option value='pwm'>PWM</option>
						</select>
						<select name="ch3_list1_list2" onClick="alert(this.options[this.options.selectedIndex].value)">
						</select>
					</th> 
					<th> 
						<select id="idCh3Div">
			            <option value="0">1.0A/div</option>
			            <option value="1">5.0A/div</option>
			            <option value="2">10.0A/div</option>
			            <option value="3">20.0A/div</option>
			            <option value="4">50.0V/div</option>
			            <option value="5">100.0/div</option>
         			</select>
					</th>
					<th><font color="hotpink">OFFSET</font>
						<input id='ch3Offset' type="number" class="offset" value="0" size="3">
					</th>
				</tr>
				<tr>
					<th><font color="palegreen">CH4</font></th> 
					<th>
						<select name="ch4_list1" onChange="updateCh4Select(this.selectedIndex)">
						<option selected>probe</option>
						<option value='I'>Amp</option>
						<option value='V'>Volt</option>
						<option value='adc'>ADC</option>
						<option value='pwm'>PWM</option>
						</select>
						<select name="ch4_list1_list2" onClick="alert(this.options[this.options.selectedIndex].value)">
						</select>
					</th> 
					<th> 
						<select id="idCh4Div">
			            <option value="0">1.0A/div</option>
			            <option value="1">5.0A/div</option>
			            <option value="2">10.0A/div</option>
			            <option value="3">20.0A/div</option>
			            <option value="4">50.0V/div</option>
			            <option value="5">100.0/div</option>
         			</select>
					</th>
					<th><font color="palegreen">OFFSET</font>
						<input id='ch4Offset' type="number" class="offset" value="0" size="3">
					</th>
				</tr>

			</table>

		</div>

		<div id ='codeEdit' class ='csCodeEdit'>
			<div id='codeEditResult' class='csEditResult'>code result</div>
			<label>Code :</label><textarea id='txtCodeEdit1' class='csCodeEdit1'>0</textarea>
			<label>Data :</label><textarea id='txtCodeEdit2' class='csCodeEdit1'>0</textarea>
			<button id='btnReadCode' 	class='w3-circle w3-green'  onclick='btnReadCode()'>R</button>
			<button id='btnWriteCode' 	class='w3-circle w3-red'    onclick='btnWriteCode()'>W</button>
			</br>
			<select id="idCmdSelect">
  				<option value="0">READADC</option>
  				<option value="1">SAVE</option>
  				<option value="2">RESET</option>
  				<option value="3">READ CODE</option>
			</select>
			<button id='btnWriteCode' 	class='w3-button w3-round w3-green' onclick='btnSendCmd()'>Send</button>
 		<div>
		<div id ='codeTable' class ='csCodeTable'>
			<textarea id='txtCodeTable' class='csTxtCodeTable' rows="8" cols="38">	</textarea>
		</div>

		<div id="cursorGroup">
			<lavel id="vcurValue1">0000</label>
			<input type="radio" id="vcursor1" name="scopeCursor" checked />V1 : 	
			<lavel id="vcurValue2">0000</label>
			<input type="radio" id="vcursor2" name="scopeCursor" />V2 :	
			<lavel id="hcurValue1">0000</label>
			<input type="radio" id="hcursor1" name="scopeCursor" />H1 :	
			<lavel id="hcurValue2">0000</label>
			<input type="radio" id="hcursor2" name="scopeCursor" />H2 	
		</div>
		<div id="scopeOffset" class="scope offset">
			<input id='ch0Offset' type="number" class="offset" value="1800" min="1" step="1" size="3">
			<label>CH0 : </label> 
			<input id='ch1Offset' type="number" class="offset" value="1800" min="1" step="1" size="3">
			<label>CH1 : </label>
			<input id='ch2Offset' type="number" class="offset" value="1800" min="1" step="1" size="3">
			<label>CH2 : </lavel>
			<input id='ch3Offset' type="number" class="offset" value="1800" min="1" step="1" size="3">
			<label>CH3</label> 
		</div>

	</div><!-- end of rightbox -->
</div>

<!-- control handlers -->
<script>
var msgTx = { selVac: 0};
var traceOnOff = 0;
var monitorOnOff = 0;

var ch1_list = document.getElementsByName('ch1_list1_list2')[0];
var ch2_list = document.getElementsByName('ch2_list1_list2')[0];
var ch3_list = document.getElementsByName('ch3_list1_list2')[0];
var ch4_list = document.getElementsByName('ch4_list1_list2')[0];

var ch1List = new Array();
ch1List[0] ='';
ch1List[1] = ['U|I_u','V|I_v','W|I_w','d|I_d','q|I_q','D|I_D','Q|I_Q'];
ch1List[2] = ['U|V_u','V|V_v','W|V_w','d|V_d','q|V_q','D|V_D','Q|V_Q'];
ch1List[3] = ['Iu|adcIu','Iv|adcIv','se|sensor','cmd|anaCmd','Vdc|adcVdc','T|adcTemp'];
ch1List[4] = ['U|pwmRatioU','V|pwmRatioV','W|pwmRatioW'];

var ch2List = new Array();
ch2List[0] ='';
ch2List[1] = ['U|I_u','V|I_v','W|I_w','d|I_d','q|I_q','D|I_D','Q|I_Q'];
ch2List[2] = ['U|V_u','V|V_v','W|V_w','d|V_d','q|V_q','D|V_D','Q|V_Q'];
ch2List[3] = ['Iu|adcIu','Iv|adcIv','se|sensor','cmd|anaCmd','Vdc|adcVdc','T|adcTemp'];
ch2List[4] = ['U|pwmRatioU','V|pwmRatioV','W|pwmRatioW'];

var ch3List = new Array();
ch3List[0] ='';
ch3List[1] = ['U|I_u','V|I_v','W|I_w','d|I_d','q|I_q','D|I_D','Q|I_Q'];
ch3List[2] = ['U|V_u','V|V_v','W|V_w','d|V_d','q|V_q','D|V_D','Q|V_Q'];
ch3List[3] = ['Iu|adcIu','Iv|adcIv','se|sensor','cmd|anaCmd','Vdc|adcVdc','T|adcTemp'];
ch3List[4] = ['U|pwmRatioU','V|pwmRatioV','W|pwmRatioW'];

var ch4List = new Array();
ch4List[0] ='';
ch4List[1] = ['U|I_u','V|I_v','W|I_w','d|I_d','q|I_q','D|I_D','Q|I_Q'];
ch4List[2] = ['U|V_u','V|V_v','W|V_w','d|V_d','q|V_q','D|V_D','Q|V_Q'];
ch4List[3] = ['Iu|adcIu','Iv|adcIv','se|sensor','cmd|anaCmd','Vdc|adcVdc','T|adcTemp'];
ch4List[4] = ['U|pwmRatioU','V|pwmRatioV','W|pwmRatioW'];

function updateTestSelect(selectedGroup){
    test_list.options.length=0;
    if (selectedGroup>0){
        for (i=0; i < testList[selectedGroup].length; i++)
            test_list.options[test_list.options.length]=new Option(testList[selectedGroup][i].split("|")[0], testList[selectedGroup][i].split("|")[1]);
    }
}

function updateCh1Select(selectedGroup){
    ch1_list.options.length=0;
    if (selectedGroup>0){
        for (i=0; i < ch1List[selectedGroup].length; i++)
            ch1_list.options[ch1_list.options.length]=new Option(ch1List[selectedGroup][i].split("|")[0], ch1List[selectedGroup][i].split("|")[1]);
    }
}

function updateCh2Select(selectedGroup){
    ch2_list.options.length=0;
    if (selectedGroup>0){
        for (i=0; i < ch2List[selectedGroup].length; i++)
            ch2_list.options[ch2_list.options.length]=new Option(ch2List[selectedGroup][i].split("|")[0], ch2List[selectedGroup][i].split("|")[1]);
    }
}

function updateCh3Select(selectedGroup){
    ch3_list.options.length=0;
    if (selectedGroup>0){
        for (i=0; i < ch3List[selectedGroup].length; i++)
            ch3_list.options[ch3_list.options.length]=new Option(ch3List[selectedGroup][i].split("|")[0], ch3List[selectedGroup][i].split("|")[1]);
    }
}

function updateCh4Select(selectedGroup){
    ch4_list.options.length=0;
    if (selectedGroup>0){
        for (i=0; i < ch4List[selectedGroup].length; i++)
            ch4_list.options[ch4_list.options.length]=new Option(ch4List[selectedGroup][i].split("|")[0], ch4List[selectedGroup][i].split("|")[1]);
    }
}


  function btnTraceOnOff(){
		monitorOnOff = 0;
		document.getElementById('btnMonitor').innerHTML = '모니터시작';

		if( traceOnOff ){
			traceOnOff = 0 ;
			document.getElementById('btnTraceOnOff').innerHTML = '측정시작';
		}else{
			traceOnOff = 1;
	  		document.getElementById('btnTraceOnOff').innerHTML = '측정중지';
		}
		socket.emit('traceOnOff',traceOnOff);
		
	}

function btnReadAll(){
	socket.emit('getCodeList',0);
}

function btnMonitor(){
	traceOnOff = 0;
	document.getElementById('btnTraceOnOff').innerHTML = '측정시작';
	if( monitorOnOff ){
		monitorOnOff = 0 ;
		document.getElementById('btnMonitor').innerHTML = '모니터시작';
	}else{
		monitorOnOff = 1;
		document.getElementById('btnMonitor').innerHTML = '모니터정지';
	}
	socket.emit('monitor',monitorOnOff);
}

function btnInvStart(){
	msgTx.selVac = 0;
	socket.emit('btnClick',msgTx);
}

function btnInvStop(){
	msgTx.selVac = 1;
	socket.emit('btnClick',msgTx);
}

function btnTestOn(){
	msgTx.selVac = 2;
	socket.emit('btnClick',msgTx);
}
function btnTestOff(){
	msgTx.selVac = 3;
	socket.emit('btnClick',msgTx);
}
function btnArmOn(){
	msgTx.selVac = 4;
	socket.emit('btnClick',msgTx);
}
function btnArmOff(){
	msgTx.selVac = 5;
	socket.emit('btnClick',msgTx);
}

function btnShutDown(){
	msgTx.selVac = 6;
	socket.emit('btnClick',msgTx);
}
function btnRestart(){
	msgTx.selVac = 7;
	socket.emit('btnClick',msgTx);
}

// '9:4:901:0.000e+0'
function getSciCmd( ){

	var returns = 'Invalid number';
	var tmp1 = document.getElementById('txtCodeEdit1').value;
	var tmp2 = document.getElementById('txtCodeEdit2').value;

	tmp1 = tmp1 * 1;
	tmp2 = tmp2 * 1;

	if(isNaN(tmp1)) return returns;
	if(isNaN(tmp2)) return returns;
	if(( tmp1 > 990 ) || ( tmp1 < 0 )) return returns;

	var sciCmd = '9:4:';
	if(tmp1 < 10){
		sciCmd = sciCmd + '00';
	} else if ( tmp1 < 100 ){ 
		sciCmd = sciCmd + '0';
	}

	sciCmd = sciCmd + tmp1 + ':';

	var codeData = tmp2.toExponential(3);
	
	sciCmd = sciCmd + codeData;

	if((sciCmd.length) != 16) return returns;

	return sciCmd;
}

function btnReadCode(){	
	var returns = getSciCmd( );

	//console.log(returns);

	if( returns.length == 16 ){
		socket.emit('codeEdit',returns);
	} else {
		document.getElementById('codeEditResult').innerHTML = returns;
	}	 
}

function btnWriteCode(){
	var returns = getSciCmd( );

	if( returns.length == 16 ){
		var test = returns.replace('4','6');
		socket.emit('codeEdit',test);
	} else {
		document.getElementById('codeEditResult').innerHTML = returns;
	}	 
}

function btnSendCmd(){
	var selector = document.getElementById("idCmdSelect");
	var value = selector[selector.selectedIndex].value;
	var cmd = '9:4:902:5.000e+0';

	if(value == 0 ){
		cmd = '9:4:910:0.000e+0';	// read adc
		socket.emit('codeEdit',cmd);
	} else if(value == 1) { 
		cmd = '9:6:900:4.000e+1';	// save
		socket.emit('codeEdit',cmd);
	} else if(value == 2) { 
		cmd = '9:4:902:5.000e+0';	// RESET
		socket.emit('codeEdit',cmd);
	}
}

function changeNoVac(){

	var msg = [];
	for( var i = 0 ; i < 600 ; i++){
		msg.push( 1500 + 50 * Math.sin( Math.PI / 30 * i ));
 	}
   traceData0.sample = msg;

	msg =[];
	for( var i = 0 ; i < 600 ; i++){
		msg.push( 1600 + 50 * Math.sin( Math.PI / 30 * i ));
 	}
   traceData1.sample = msg;

	msg =[];
	for( var i = 0 ; i < 600 ; i++){
		msg.push( 1700 + 50 * Math.sin( Math.PI / 30 * i ));
 	}
   traceData2.sample = msg;

	msg =[];
	for( var i = 0 ; i < 600 ; i++){
		msg.push( -1800 + 50 * Math.sin( Math.PI / 30 * i ));
 	}
   traceData3.sample = msg;

   oscope.onPaint(trace);
}


  //--- sampling bits
// =============================================
  // volts per division
  // =============================================

  $('#volts10' ).on('change',null,function() {oscope.onVoltsPerDiv(0.1 );});
  $('#volts25' ).on('change',null,function() {oscope.onVoltsPerDiv(0.25);});
  $('#volts50' ).on('change',null,function() {oscope.onVoltsPerDiv(0.5 );});
  $('#volts100').on('change',null,function() {oscope.onVoltsPerDiv(1.0 );});

  $('.vdiv' ).on('change',null,function(event) {
        oscope.onVoltsPerDiv(parseFloat(event.target.parentElement.innerText));
      }
  );

  // =============================================
  // set offset 
  // =============================================
  $('#ch0Offset' ).on('change',null,
		function(){
			var temp = document.getElementById('ch0Offset').value;
			//console.log(temp);
			// oscope.onVerticalOffset(1,temp);
		}
  );

  // =============================================
  // canvas mouse event for cursor drag
  // =============================================
  var mouse_state = 0;
  $('#oscope').on('mousedown',function(event) {
    mouse_state = 1;

    oscope.onCursorMove(event.offsetX,event.offsetY);
  });

  $('#oscope').on('mouseup',function() {
    mouse_state = 0;

  });

  $('#oscope').on('mouseout',function() {
    mouse_state = 0;
  });

  $('#oscope').on('mousemove',function(event) {
    switch(mouse_state) {
    case 0:
      // do nothing
      break;
    case 1:
      oscope.onCursorMove(event.offsetX,event.offsetY);
		var temp = (225 - event.offsetY) * 4096 / 450;
		var x = document.getElementById('vcursor1').checked;

		if( x ) {
			document.getElementById('curVerStartPosi').innerHTML = parseInt(temp);
		}else{
			document.getElementById('curVerEndPosi').innerHTML = parseInt(temp);
		}
      break;
    }
  });

  // =============================================
  // cursor select
  // =============================================
  $('#hcursor1' ).on('change',null,function() {oscope.onCursorSelect(0);});
  $('#hcursor2' ).on('change',null,function() {oscope.onCursorSelect(1);});
  $('#vcursor1' ).on('change',null,function() {oscope.onCursorSelect(2);});
  $('#vcursor2' ).on('change',null,function() {oscope.onCursorSelect(3);});

  function setChannelOffset(channel,element) {
    var offset = parseInt(element.value);
    if (offset < -4) {
      element.value = "-4";
      offset = -4;
    }
    if (offset > 4) {
      element.value = "4";
      offset = 4;
    }
    oscope.onVerticalOffset(channel,offset);
  }

  $('#channel1v').on('change',null,
      function() {
        var element = $('#channel1v')[0];
        setChannelOffset(1,element);
      }
  );

  $('#channel2v').on('change',null,
      function() {
        var element = $('#channel2v')[0];
        setChannelOffset(2,element);
      }
  );

  $('#channel3v').on('change',null,
      function() {
        var element = $('#channel3v')[0];
        setChannelOffset(3,element);
      }
  );

  $('#channel4v').on('change',null,
      function() {
        var element = $('#channel4v')[0];
        setChannelOffset(4,element);
      }
  );

socket.on('codeTable', function (msg) {
   var testIn = msg.toString();
   //testIn.replace(/:,/g,'\r\n');
   var testIn1 = testIn.replace(/:/g,'\r\n');
   var testOut = testIn1.replace(/,/g,'\t');
   // console.log(testIn);
   document.getElementById('txtCodeTable').innerHTML = testOut;
});

socket.on('codeEdit',function(msg){
	document.getElementById('codeEditResult').innerHTML = msg;
});	

var monitorCount=0;

socket.on('monitor',function(msg){
	
	(monitorCount > 99 ) ? monitorCount = 0 : monitorCount++;

	var msgOut = document.getElementById('stopRecord').innerHTML;
	if((monitorCount %5) == 0 ) msgOut ='';  
	document.getElementById('stopRecord').innerHTML = msgOut + '#'+ monitorCount +' '+ msg;
});	

</script>
{% endblock %}
